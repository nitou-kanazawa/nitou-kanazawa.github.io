---
title: String型のメモリ使用
description: 
categories: [C#]
tags:
  - C#
---

## 概要

C#のstring型はクラスとして実装されており，生成のたびにヒープアロケーションが発生するため，しばしばパフォーマンス低下の要因になりえる．そのため，まずは理解を深めるため，`string`型がヒープ上にどのように展開されるかを確認してみる．


## SharpLabでの確保メモリ確認

以下の`string`型で確保されるメモリについて確認してみる．

```cs
string str = "Hello world";
```

#### メモリレイアウト

`string`型は**不変（immutable）** な参照型のオブジェクトであり、ヒープ上に格納される．メモリレイアウトは次のようになる．

1. **オブジェクトヘッダー（Object Header）**  
   - .NET のガベージコレクション管理のためのメタデータ  
   - 8 バイト（64bit 環境）または 4 バイト（32bit 環境）  
   - ロック情報や型情報を格納  

2. **タイプハンドル（Type Handle）**  
   - `System.String` を示す型情報へのポインタ  
   - .NET の型システムによって管理  

3. **文字列の長さ（_stringLength）**  
   - 格納されている `char`（UTF-16）の数（バイト数ではない）  

4. **文字データ（_firstChar 以降）**  
   - 文字列の中身（UTF-16）  
   - `.NET` の `char` は **2 バイト**（UTF-16 LE）  
   - `null` 終端（\0）はあるが、実際の文字列長にはカウントされない  

---



#### ヘッダー

```
00	00	00	00	00	00	00	00 | 40	BF	24	37	FC	7F	00	00	
```
- **オブジェクトヘッダー（8バイト）**
  - `00 00 00 00 00 00 00 00`  
  - `.NET`のオブジェクト管理用情報（ロックやGC関連）．

- **タイプハンドル（8バイト）**
  - `40 BF 24 37 FC 7F 00 00`
  - `System.String` を示す型情報へのポインタ．

---

#### データ本体

```
0B	00	00	00
```

- **文字列の長さ（4バイト）**
  - `0B 00 00 00` → **11（0x0B）**
  - `"Hello world"` は **11 文字**（スペース込み）


```
48	00	65	00	6C	00	6C	00	6F	00	20	00	77	00	6F	00	72	00	6C	00	64	00	00	00
```

- **文字列データ（UTF-16 LE）**
  - `48 00` → `H`
  - `65 00` → `e`
  - `6C 00` → `l`
  - `6C 00` → `l`
  - `6F 00` → `o`
  - `20 00` → **スペース**
  - `77 00` → `w`
  - `6F 00` → `o`
  - `72 00` → `r`
  - `6C 00` → `l`
  - `64 00` → `d`
  - `00 00` → **null 終端（\0）**

---

この `string` のメモリレイアウトは次のようになっており，合計で `44 バイト`（= 8 + 8 + 4 + 22 + 2）使用している．

| 項目                 | サイズ | 説明                     |
| -------------------- | ------ | ------------------------ |
| オブジェクトヘッダー | 8B     | .NET の GC やロック情報  |
| 型ハンドル           | 8B     | `System.String` の型情報 |
| 文字列の長さ         | 4B     | 文字数（11）             |
| 文字データ           | 22B    | UTF-16 形式（`H`～`d`）  |
| null 終端            | 2B     | `\0`                     |


- **なぜ UTF-16？**
  - C#の`string`は歴史的な経緯から**UTF-16**でエンコードされるため、1文字あたり**2バイト**で格納される．

- **なぜ null 終端があるのか？**
  - .NET の `string` は `Length` プロパティで管理されるため、C 言語のように `null` 終端は必須ではない．
    しかし，相互運用性のために `null` 終端が付いていることがある．


## 参考資料